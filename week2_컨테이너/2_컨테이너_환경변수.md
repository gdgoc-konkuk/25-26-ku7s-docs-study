# 컨테이너 환경변수

정의: 컨테이너 환경변수는 **Pod 안에서 실행 중인 컨테이너가 어떤 환경에서 동작하는지** 를 다루는 개념이다.

## 🧩 컨테이너 환경의 주요 구성 요소

| 구분 | 설명 | 예시 |
| --- | --- | --- |
| **1. 파일시스템 (Filesystem)** | 각 컨테이너는 **자신의 이미지 기반 파일 시스템**을 사용함. 여기에 쿠버네티스에서 정의한 **볼륨(volume)이 마운트**되어 데이터 공유가 가능함. | `/usr`, `/app`, `/data` 등
`emptyDir`, `configMap`, `secret` 볼륨 |
| **2. 환경 변수 (Environment Variables)** | 쿠버네티스는 컨테이너 시작 시 자동으로 여러 환경 변수를 설정해줌. | `KUBERNETES_SERVICE_HOST`, `KUBERNETES_SERVICE_PORT` |
| **3. 서비스 환경 변수 (Service Environment Variables)** | 동일 네임스페이스 내의 서비스가 자동으로 환경 변수로 주입됨.단, **서비스가 Pod보다 먼저 생성되어야 함** | `MYAPP_SERVICE_HOST`, `MYAPP_SERVICE_PORT` |
| **4. Downward API** | 컨테이너 내부에서 **Pod의 메타데이터**(이름, 네임스페이스, 라벨 등)에 접근할 수 있도록 해줌. | `metadata.name`, `metadata.labels` |
| **5. 클러스터 DNS** | 모든 Pod는 클러스터 DNS를 사용하여 **서비스 이름으로 통신 가능** | `curl http://my-service.my-namespace.svc.cluster.local` |
| **6. 호스트 네임 (Hostname)** | 기본적으로 **Pod의 이름이 컨테이너의 호스트네임**으로 설정됨 | `hostname` 명령 실행 시 `pod-name` 표시 |

### 1. 파일 시스템

- 각 컨테이너는 **자신의** **이미지(image) 기반 파일 시스템**을 사용한다.
- 여기에 쿠버네티스에서 정의한 **볼륨(Volume)이 마운트**되어 데이터 공유가 가능하다.

```yaml
volumes:
  - name: shared-data
    emptyDir: {}
containers:
  - name: app
    image: busybox
    volumeMounts:
      - name: shared-data
        mountPath: /data
  - name: sidecar
    image: busybox
    volumeMounts:
      - name: shared-data
        mountPath: /backup
```

같은 `Pod` 안의 컨테이너(`app`,`sidecar`)가 볼륨을 통해 파일 공유 → **Pod 수준에서  파일 시스템 일부 공유**

### 2. 환경 변수

- 컨테이너가 시작될 때 쿠버테이스는 자동으로 여러 환경 변수를 설정해준다.
- 개발자는 `env` 필드로 **직접 환경 변수를 정의**하거나, `ConfigMap`/`Secret`을 통해 관리형으로 설정 가능

```yaml
env:
  - name: MODE
    value: "production"
  - name: DB_HOST
    valueFrom:
      configMapKeyRef:
        name: db-config
        key: host
  - name: DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: db-secret
        key: password
```

→ 이 경우, 코드에 민감한 정보는 외부 설정으로 넣을 수 있다. 

### 3. 서비스 환경 변수

- 쿠버네티스는 **동일 네임스페이스 내의 서비스 정보**를 환경 변수로 자동 주입한다.
    
    **→ 단, 서비스가 Pod보다 먼저 생성되어야 한다.** 
    

### 4. Download API

- 컨테이너가 **자신의 Pod 메타데이터나 status 정보**를 읽을 때 사용한다.
- 쿠버네티스가 제공하는 “자기 참조” 메커니즘으로 Pod 이름, 네이스페이스, 라벨, 어노테이션, 리소스 요청량 등을 컨테이너 내부로 전달할 수 있다.

```yaml
env:
  - name: POD_NAME
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  - name: POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
```

→ Pod 내부에서 [`metadata.name`](http://metadata.name) 등을 통해 **Pod 스스로 자신의 정보를 인식**하게 한다. 

### 5. 클러스터 DNS

- 쿠버네티스 클러스터 내부에는 **CoreDNS**라는 DNS 서버가 기본 설치되어 있다.
- 모든 Pod는 자동으로 CoreDNS 주소를 설정하고, **서비스 이름으로 통신**할 수 있다.

### 6. 호스트 네임

- 기본적으로 **Pod의 이름 == 컨테이너의 hostname**
- 동일 Pod 내 여러 컨테이너는 같은 호스트네임을 공유하지만, 각 Pod는 독립된 네트워크 네임스페이스를 가진다.

```bash
$ hostname
myapp-pod-5b6c7d8f9
```

→ Pod 내부에서 `hostname`을 찍으면  `pod-name` 이 출력된다.

## 🧠 핵심 포인트

| 주제 | 핵심 요약 |
| --- | --- |
| **Pod 내부 공유** | 같은 Pod 내 컨테이너들은 **네트워크(127.0.0.1)와 볼륨을 공유**함. |
| **환경 변수 자동 설정** | 쿠버네티스가 자동으로 클러스터 정보와 서비스 정보를 환경 변수로 넣어줌. |
| **Downward API** | Pod의 메타데이터를 컨테이너 내부에 전달하기 위한 수단. |
| **DNS 통합** | 서비스 간 통신은 환경 변수 외에도 DNS 이름으로 가능함. |
| **실행 순서 중요** | 서비스가 먼저 생성되어야 환경 변수로 주입됨. |