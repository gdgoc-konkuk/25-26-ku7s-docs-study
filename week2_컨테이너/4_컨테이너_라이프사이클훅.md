# 컨테이너 라이프사이클훅

정의: 쿠버네티스에서 컨테이너는 **“생성 → 실행 → 종로”** 라는 **생명주기(lifecycle)**를 가지는데, 이 과정 중에 **특정 시점(PostStart/PreStop)**에 사용자 정의 동작(스크립트나 명령)을 실행할 수 있게 해주는 기능이다.

* **특정 시점**: 컨테이너 이미 + 환경 + 런타임 등이 준비된 이후, 혹은 종료되기 직전

## 🧩 컨테이너 훅의 종류

| Hook 이름 | 실행 시점 | 대표적인 활용 예시 |
| --- | --- | --- |
| **PostStart** | 컨테이너가 생성된 직후 | 초기화 스크립트 실행, 로그 디렉터리 생성, 설정 파일 복사 |
| **PreStop** | 컨테이너가 종료되기 직전 | 세션 정리, 연결 끊기, 종료 알림 전송, 로그 flush |
| **StopSignal** *(v1.33 추가)* | 컨테이너가 종료될 때 전달할 시그널을 지정 | SIGTERM 외 다른 시그널을 전달해야 할 떄 사용(ex. SIGINT) |
- `PostStart`는 컨테이너가 완전히 시작되기 전에 실행되지만, 컨테이너 내부의 메인 프로세스(ENTRYPOINT)가 시작되지 전에 반드시 실행된다는 보장은 없다.
    
    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: poststart-demo
    spec:
      containers:
      - name: app
        image: busybox
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "echo Container started at $(date) > /message"]
        command: ["sleep", "3600"]
    ```
    
    → 컨테이너가 시작될 때, `/message` 파일을 만들어 “시작 시간” 을 기록한다.
    
- `PreStop`은 종료 신호(SIGTERM 등)를 받지 직전에 실행되며, 이 훅이 끝날 때까지 컨테이너는 실제로 종료되지 않는다.
    
    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: prestop-demo
    spec:
      containers:
      - name: app
        image: busybox
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "echo Container stopping at $(date) >> /message"]
        command: ["sleep", "3600"]
    ```
    
    → 컨테이너가 종료될 때, `/message` 파일을 만들어 “종료 시간” 을 기록한다.
    

## ⚙️ 훅의 실행 방식 (Handler 유형)

→ 훅 안에서 실행할 “작업”의 정의

| Handler 종류 | 설명 | 예시 |
| --- | --- | --- |
| **exec** | 컨테이너 내부에서 명령어를 실행 | `["/bin/sh", "-c", "echo Hello"]` |
| **httpGet** | 컨테이너 내부 or 회부에서  HTTP 요청을 해당 컨테이너의 엔드포인트로 전송 | `path: /ready`, `port: 8080` |
| **sleep** *(v1.33 추가)* |  지정한 시간만큼 대기 | `sleep: 10s` |

## 🧠 주의사항

| 항목 | 설명 |
| --- | --- |
| **PostStart 지연** | 훅이 오래 걸리면 컨테이너가 “Running” 상태로 전환되기까지 시간이 늦어질 수 있다. |
| **PreStop 지연** | 훅이 너무 오래 걸리면 파드가 “Terminating” 상태에서 멈출 수 있다. |
| **실패 처리** | 훅 명령이 실패(exit code ≠ 0)하면 컨테이너가 바로 종료될 수 있다. |
| **병렬 실행 주의** | PostStart와 ENTRYPOINT는 동시에 실행될 수 있어 순서가 완벽히 보장되지 않는다.
→ ENTRYPOINT 실행 전에 훅이 완료될 것을 보장하지 않는다. |
| **리소스 제한 포함** | 훅이 사용하는 CPU/메모리도 컨테이너 리소스 제한에 포함된다.
즉, 컨테이너 내부에서 실행될 경우 해당 리소스가 컨테이너에 귀속된다.  |

## ⚒️ 훅의 실행 순서

1. 컨테이너가 생선된다,
2. PosrStart 훅이 즉시 실행된다.
    1. ENTRYPOINT와 동시에 시작되거나 PostStart가 끝날 때까지 대기하지 않을 수도 있다.
    2. PostStart가 실행 중 오류가 발생하면 컨테이너가 종료될 수도 있다. 
3. 컨테이너 메인 프로세스 실행 중
4. 쿠버네티스가 종료 신호를 보낸다.
5. PreStop 훅이 실행된다.
    1. PreStop이 너무 오래 걸리면 Pod가 “Terminating” 상태에서 지연될 수 있다.
6. PreStop이 끝나면 지정된 grace period 후 컨테이너가 종료된다.

## ✅ 훅 실행 보장 (Delivery Guarantees)

정의: 훅은 **최소 한 번** 실행될 수 있다는 의미는 훅이 **중복 실행될 가능성**도 있다는 것을 의미하고 이는 훅에 **중복 실행되어도 문제없는 동작을 작성**해야 한다는 의미다. (ex. 이미 정리된 자원을 다시 정리해도 괜찮은 코드)

- 쿠버네티스가 훅 실행을 시도하지만, HTTP 훅 수신기가 다운되어 트래픽을 받을 수 없는 경우 실행되지 못할 수도 있다.
- 이런 경우라도 일반적으로 전달은 한번만 이뤄지지만, 드문 경우로 이중 전달이 발생할 수 있다.
    
    → 노드가 비정상 종료되거나 Kublet이 충돌한 경우, 훅을 전송하는 도중에 kublet 재시작 상황에서는 훅이 재전송 되어 **중복 실행될 가능성**도 있다. 
    
- 훅 실패 시 동작
    - **PostStart:** 컨테이너 시작 실패로 간주 → 컨테이너가 바로 종료된다.
    - **PreStop:** 컨테이너 종료는 계속 진행되지만 로그에 실패 이벤트가 기록된다.

## 💻 훅 디버깅 (Debugging Hook)

훅 실행 결과는 **Pod 로그에 직접 나타나지 않음** → 대신 Kublet 이벤트로 표시된다.

- 이벤트 이름:
    - `FailedPostStartHook`
    - `FailedPreStopHook`
- 확인 방법:
    
    ```bash
    kubectl describe pod <pod-name>
    ```
    
    → 이벤트 섹션에서 성공/실패 여부 확인 가능