# 네트워크 정책

파드 간의 네트워크 트래픽을 IP 주소나 포트 레벨에서 제어하는 정책. Kubernetes의 기본 설정은 매우 개방적인데, 네트워크 정책을 사용하면 **어떤 파드들이 서로 통신할 수 있는지** 명시적으로 정의할 수 있음.

## 파드 격리의 두 가지 종류: Ingress & Egress

**Ingress (인바운드)** : 파드로 들어오는 트래픽을 제어. **기본적으로 모든 인바운드가 허용** 되지만, Ingress 규칙이 있는 네트워크 정책이 적용되면 **그 규칙만 허용.**

**Egress (아웃바운드)** : 파드에서 나가는 트래픽을 제어. **기본적으로 모든 아웃바운드가 허용** 되지만, Egress 규칙이 있으면 **그 규칙만 허용.**

> 리스트 각 항목의 효과는 합산되어 적용된다.


## 네트워크 정책 예시
```YAML
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: test-network-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from: # 누가 접근하려고 하는지. db pod로 들어오는 트래픽 출처를 명시하는 것
        - ipBlock:
            cidr: 172.17.0.0/16
            except:
              - 172.17.1.0/24
        - namespaceSelector:
            matchLabels:
              project: myproject
        - podSelector:
            matchLabels:
              role: frontend
      ports:
        - protocol: TCP
          port: 6379
  egress:
    - to: # 어디로 나가려고 하는지. db pod에서 나가는 트래픽 목적지 명시
        - ipBlock: # 여기 명시된 IP만 '허용' 나머지는 모두 차단
            cidr: 10.0.0.0/24
      ports:
        - protocol: TCP
          port: 32000
          endPort: 32768 # 32000부터 32768까지의 포트의 통신 허용
```

#### **`role: db` 레이블을 가진 Pod들의 네트워크 트래픽을 제어**하는 정책.

### 적용 대상
- **네임스페이스**: default
- **대상 Pod**: `role: db` 레이블이 붙은 Pod들

### Ingress (유입 트래픽)
db Pod로 **들어오는 트래픽**을 허용하는 조건:

1. **IP 블록**: `172.17.0.0/16` CIDR에서의 요청 (단, `172.17.1.0/24` 제외)
2. **네임스페이스**: `project: myproject` 레이블이 있는 네임스페이스의 모든 Pod
3. **Pod**: `role: frontend` 레이블을 가진 Pod

위 3가지 출처에서 **TCP 6379 포트**로의 연결만 허용.

### Egress (유출 트래픽)
db Pod에서 **나가는 트래픽**:

- **목적지**: `10.0.0.0/24` CIDR의 IP들
- **포트**: TCP 32000~32768 포트로의 연결만 허용

### 결과
이 정책이 적용되면 db Pod는:
- ✅ frontend Pod, myproject 네임스페이스, 172.17.0.0/16에서만 유입 허용
- ✅ 10.0.0.0/24로만 아웃바운드 가능
- ❌ 다른 모든 트래픽은 차단됨