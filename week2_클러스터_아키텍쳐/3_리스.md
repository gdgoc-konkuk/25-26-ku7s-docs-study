# 3. 리스

> 공유 리소스를 잠그고 노드 간의 활동을 조정하는 메커니즘을 제공


'Lease'는 단어 뜻 그대로 "임대" 또는 "대여"를 의미하며, 쿠버네티스 클러스터 내의 여러 컴포넌트(구성요소)들이 **"나 아직 살아있어!"**라고 알리거나 **"지금 내가 대장(리더)이야!"**라고 표시하기 위해 사용하는 **가벼운(lightweight) 객체**

## 3.1. 노드 하트비트

노드 하트비트란? : 각 노드(워커 머신)가 컨트롤 플레인(Control Plane)에게 "저는 아직 건강하게 작동 중입니다"라고 알리는 주기적인 신호

모든 `노드`에는 **같은 이름을 가진 `Lease` 오브젝트가 `kube-node-lease` 네임스페이스에 존재**한다. 내부적으로, 모든 kubelet 하트비트는 이 `Lease` 오브젝트에 대한 업데이트 요청이며, 이 업데이트 요청은 `spec.renewTime` 필드를 업데이트한다.


### 3.1.1. 노드 리스 (Node Lease)

과거(쿠버네티스 1.13 버전 이전)에는 `kubelet`이 **노드 상태(`NodeStatus`) 전체를 주기적으로 업데이트하는 방식**으로 하트비트를 전송. 하지만 이 `NodeStatus`에는 노드의 모든 정보(컨테이너 이미지 목록, 리소스 상태 등)가 포함되어 있어 매우 "무거운" 데이터.

**모든 노드가 이 무거운 데이터를 10초마다 전송**하니 API 서버(컨트롤 플레인)에 큰 부담.
이 성능 문제를 해결하기 위해 **"노드 리스(Node Lease)"**라는 별도의 가벼운 객체가 도입.

**작동 방식:**
1. **가벼운 리스 객체:** 각 노드는 `kube-node-lease`라는 별도 네임스페이스에 **자신만의 `Lease` 객체**를 가짐. "마지막 갱신 시간" 정도의 정보만 소유.
2. **진짜 하트비트:** `kubelet`은 이제 10초마다 무거운 `NodeStatus` 대신, 이 **가벼운 `Lease` 객체를 갱신(renew)**.
3. **컨트롤러의 확인:** 노드 컨트롤러는 `NodeStatus`가 아닌 이 **`Lease` 객체가 제때 갱신되는지를 감시**합니다.
4. **리스 만료 = 장애:** 만약 `kubelet`이 정해진 시간 안에 `Lease`를 갱신하지 못하면(리스 만료), 컨트롤러는 해당 노드에 문제가 생겼다고 판단.

## 3.2. 리더 선출 (Leader Election)

컨트롤러 매니저(Controller Manager)나 스케줄러처럼 클러스터 전체에서 오직 하나만 실행되어야 하는 컴포넌트들이 있음. (High Availability, 고가용성 구성 시)

이때 여러 복제본(replica) 중에 **누가 현재 '리더'인지** 정해야 하는데, 이때도 `Lease` 객체를 사용.

- 여러 후보가 `Lease` 객체를 선점하려고 시도.
    
- 성공한 인스턴스(리더)만 주기적으로 해당 `Lease`를 갱신하며 "내가 계속 리더야"라고 알림.
    
- 만약 리더가 죽어서 `Lease` 갱신을 멈추면, 정해진 시간이 지난 후 다른 후보가 그 `Lease`를 빼앗아 새로운 리더가 됨.


## 3.3. kube-apiserver 신원
각 `kube-apiserver`는 **리스 API**를 사용하여 시스템의 나머지 부분에 자신의 신원을 게시. 
그 자체로는 특별히 유용하지는 않지만, 이것은 클라이언트가 **쿠버네티스 컨트롤 플레인을 운영 중인 `kube-apiserver` 인스턴스 수를 파악할 수 있는 메커니즘을 제공**.
kube-apiserver 리스의 존재는 향후 각 **kube-apiserver 간의 조정이 필요할 때 기능을 제공**해 줄 수 있다.

```shell
$ kubectl -n kube-system get lease -l k8s.io/component=kube-apiserver
NAME                                        HOLDER                                                                           AGE
kube-apiserver-c4vwjftbvpc5os2vvzle4qg27a   kube-apiserver-c4vwjftbvpc5os2vvzle4qg27a_9cbf54e5-1136-44bd-8f9a-1dcd15c346b4   5m33s
kube-apiserver-dz2dqprdpsgnm756t5rnov7yka   kube-apiserver-dz2dqprdpsgnm756t5rnov7yka_84f2a85d-37c1-4b14-b6b9-603e62e4896f   4m23s
kube-apiserver-fyloo45sdenffw2ugwaz3likua   kube-apiserver-fyloo45sdenffw2ugwaz3likua_c5ffa286-8a9a-45d4-91e7-61118ed58d2e   4m43s

```
