# 2. 컨트롤 플레인-노드 간 통신

>[!note] 
문서의 목적 : <br>
API 서버와 쿠버네티스 클러스터 사이에 대한 통신 경로의 목록.
사용자가 신뢰할 수 없는 네트워크에서 클러스터를 실행할 수 있도록 네트워크 구성을 강화하기 위한 맞춤 설치.


## 2.1. 노드에서 컨트롤 플레인으로의 통신

쿠버네티스는 "허브 앤 스포크(hub-and-spoke)" API 패턴을 가짐. 
>[!TIP]
허브 앤 스포크(Hub-and-Spoke)란? **중앙 집중식 통신 및 관리 모델**을 비유하는 용어. 예시로..
>- **허브 (Hub):** 인천국제공항 같은 대형 중앙 공항
>- **스포크 (Spoke):** 광주, 대구, 부산 등 지방 공항
>
> 승객이 광주(스포크)에서 대구(스포크)로 갈 때 **직접 가는 비행편(스포크-스포크) 대신**, 광주에서 인천(허브)으로 이동한 뒤, 인천(허브)에서 다시 대구(스포크)로 가는 비행기를 타는 방식

노드(또는 노드에서 실행되는 파드들)의 모든 API 사용은 API 서버에서 종료.
기본적으로, 다른 컨트롤 플레인 컴포넌트 중 **어느 것도 원격 서비스를 노출하도록 설계되지 않음**. 
API 서버는 하나 이상의 클라이언트 인증 형식이 활성화된 **보안 HTTPS 포트(일반적으로 443)에서 원격 연결을 수신하도록 구성**된다. 특히 익명의 요청 또는 서비스 어카운트 토큰이 허용되는 경우, 하나 이상의 **권한 부여 형식**을 사용해야 함.


## 2.2. 컨트롤 플레인에서 노드로의 통신
컨트롤 플레인(API 서버)에서 노드로는 두 가지 기본 통신 경로가 있음.
- 첫 번째는 API 서버에서 클러스터의 **각 노드에서 실행되는 kubelet 프로세스**. 
- 두 번째는 API 서버의 프록시 기능을 통해 **API 서버에서 모든 노드, 파드 또는 서비스에 이르는 것**.

### 2.2.1. API 서버에서 kubelet으로의 통신

API 서버에서 kubelet으로의 연결은 다음의 용도로 사용.

- 파드에 대한 로그를 가져옴.
- **실행 중인 파드에 (보통의 경우 kubectl을 통해) 연결.**
- kubelet의 포트-포워딩 기능을 제공.

위와 같은 연결은 kubelet의 HTTPS 엔드포인트에서 종료.

>[!warning]
**API 서버는 kubelet의 제공(serving) 인증서를 확인하지 않음.** 이는 연결이 중간자 공격(man-in-the-middle)에 시달리게 하며, 신뢰할 수 없는 네트워크 및/또는 공용 네트워크에서 실행하기에 안전하지 않음.


#### 해결책 1: Kubelet 인증서 확인 (권장)

이것이 가장 표준적이고 권장되는 보안 방식.

- **방법:** API 서버를 시작할 때 `--kubelet-certificate-authority` 라는 플래그(옵션)를 사용.
    
- **작동 원리:** 이 플래그는 API 서버에게 "신뢰할 수 있는 인증서 발급 기관(CA)의 목록"을 알려줌.
    
- **결과:** 이제 API 서버는 kubelet에 연결할 때마다 kubelet이 제시하는 인증서를 받음. 그리고 "이 인증서가 내가 신뢰하는 CA로부터 발급된 것이 맞는지" 확인. 확인이 되어야만 통신을 시작
    

#### 해결책 2: SSH 터널링 (차선책)

만약 위 1번 방법(인증서 설정)을 사용하기 어려운 상황이라면, 이 방법을 사용할 수 있음

- **방법:** API 서버와 kubelet 간의 네트워크 통신 전체를 안전한 **SSH 터널** 안에 넣어서 전송
    
- **작동 원리:** SSH 터널링은 두 지점 간에 매우 강력하게 암호화된 '비밀 통로'를 만드는 기술
    
- **결과:** 중간에 공격자가 있더라도, 모든 통신 내용이 이 비밀 통로 안에서 암호화되어 전송되기 때문에 내용을 엿보거나 조작할 수 없음
