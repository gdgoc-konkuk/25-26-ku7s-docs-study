# 쿠버네티스 오브젝트 이해하기

오브젝트란 쿠버네티스가 관리하는 모든 리소스의 최소 단위

예: Pod, Service, Deployment, ReplicaSet, StatefulSet 등

- 어떤 컨테이너화된 애플리케이션이 동작 중인지
- 그 애플리케이션이 이용할 수 있는 리소스
- 그 애플리케이션이 어떻게 동작해야하는지에 대한 정책

등을 담고있음

<aside>

Declarative 방식(선언적 관리): 원하는 상태를 선언하고, 실제 동작은 컨트롤 플레인이 수행하는 방식

</aside>

> 쿠버네티스에게 워크로드를 어떤 형태로 보이고자 하는지에 대한 “의도한 상태”를 전달해야 함
> 

쿠버네티스 오브젝트를 동작시키기위해서 쿠버네티스 API를 사용 

- kubectl 사용하는 경우 CLI가 필요한 쿠버네티스 API를 호출해줌
- 클라이언트 라이브러리를 이용해 자신의 프로그램에서 쿠버네티스 API 직접 사용 가능

### 오브젝트 spec과 status

**Spec**: 원하는 상태를 의미

**Status**: 현재 상태를 의미

쿠버네티스의 컨트롤 플레인은 모든 오브젝트의 상태(status)를 사용자가 의도한 상태(spec)와 일치시키기위해 끈임없이 관리

- 예시
    
    Deployment라는 클러스터에서 동작하는 애플리케이션을 표현하는데 사용되는 쿠버네티스 오브젝트를 사용할 때 이를 생성하기 위해 .yaml 파일에 기본적인 정보와 spec을 기술해야 함
    
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx-deployment
      labels:
        app: nginx
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx:1.14.2
            ports:
            - containerPort: 80
    ```
    
    여기서 애플리케이션 레플리카가 3개 동작되도록 설정했을 때, 시스템은 spec 읽고, spec에 일치되도록 상태를 업데이트해 3개의 애플리케이션 인스턴스를 구동시킴
    
    이 때, 인스턴스들 중 어느하나가 멈출 경우 시스템은 이러한 spec과 status 간의 차이에 대응함
    

### 쿠버네티스 오브젝트 기술하기

쿠버네티스 API 요청 시에, 정보는 JSON 형식으로 포함되어야 함

→ 사용자는 대부분 정보를 .yaml 파일로 kubectl에 제공하면, kubectl이 자동적으로 API 요청 시에 JSON으로 변환시켜줌

<aside>

Controller manage: spec과 status를 통해 실제 상태를 조정하는 역할

kubelet(노드 단위 에이전트): 실제 컨테이너 실행 및 상태 보고 담당

</aside>

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 2 # tells deployment to run 2 pods matching the template
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

```bash
kubectl apply -f https://k8s.io/examples/application/deployment.yaml
...
deployment.apps/nginx-deployment created
```

이런 식으로 인자값으로 파일을 전달해 apply를 사용할 수 있음

### 요구되는 필드

| apiVersion | 이 파일에서 사용하고 있는 쿠버네티스 API 버전 |
| --- | --- |
| kind | 어떤 종류의 오브젝트를 생성하고자 하는지 |
| metadata | name, uid, namespace를 통해 오브젝트를 구분지어주는 데이터 |
| spec | object에 의도하는 상태 |

오브젝트 spec에 대한 포맷은 오브젝트마다 다르기 때문에 쿠버네티스 API 레퍼런스를 확인해야 함

- 예시
    
    파드의 경우, 파드의 원하는 상태(컨테이너 이미지)
    
    스테이트풀셋 API의 경우, 스테이트풀셋과 원하는 상태
    
    스테이트풀셋의 .spec에는 파드 오브젝트에 대한 템플릿이 존재해 스테이트풀셋 spec을 만족시키기위해 스테이트풀셋 컨트롤러가 생성할 파드에 대한 상세 사항을 설명
    
    <aside>
    
    StatefulSet은 Pod의 상태를 유지하고 관리할 때 사용하는 오브젝트
    
    </aside>