## 크론잡

크론잡은 정해진 시간이 되면 `잡`을 생성하는 것이다.

---

1. **크론잡이란?**

- 자동화된 스케줄러와 같다.
- 반복되는 일정에 따라 잡을 생성한다.
  - 하나의 크론잡 객체는 크론탭 파일의 한줄과 같다.
  - 즉, 크론 형식으로 작성된 스케줄에 따라 주기적으로 잡을 실행시킨다.
  - 백업, 리포트 생성 등 정기적으로 수행해야 하는 작업을 자동화하는 데 사용된다.
- 모든 크론잡 일정은 기본적으로 `kube-controller-manager`의 시간대를 기준으로 한다.
  - v1.25 [beta]부터 `spec.timeZone` 필드로 타임 존을 명시할 수도 있다.
- 크론잡의 이름은 유효한 DNS 서브도메인 이름이어야 하며, 52자 이하여야 한다.
  - 크론잡 컨트롤러가 생성되는 잡 이름에 11자(고유 ID)를 자동으로 추가하며, 잡 이름의 최대 길이는 63자이기 때문

---

2. **예시**

- 자세한 형식은 아래의 링크를 참고하자.

  - 예시에 크론잡 문법에 대한 설명이 있다.

    [크론잡](https://kubernetes.io/ko/docs/concepts/workloads/controllers/cron-jobs/#%ED%81%AC%EB%A1%A0%EC%9E%A1)

  ```yaml
  apiVersion: batch/v1
  kind: CronJob
  metadata:
  name: hello
  spec:
  schedule: "* * * * *"
  jobTemplate:                      #잡(Job)의 설계도
      spec:
      template:
          spec:
          containers:
          - name: hello
              image: busybox:1.28
              imagePullPolicy: IfNotPresent
              command:
              - /bin/sh
              - -c
              - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
  ```

- "매분마다"(`* * * * *`) "Hello"라고 외치는 잡(Job)을 생성하라는 매우 간단한 반복 일정이다.
  - 이는 크론 스케줄 문법에 의한 것인데
    - 스케줄 문법은 5개의 필드로 구성된다: `(분) (시) (일) (월) (요일)`.
    - 각 필드에는 특정 숫자나 `*`(모든 값), `*/5`(5분마다) 등을 사용할 수 있다.
    - `@yearly`, `@monthly`, `@weekly`, `@daily`, `@hourly` 같은 편리한 축약 표현도 제공된다.

---

3. **크론잡의 한계**

- **`약` 한번 실행**
  - 크론잡은 일정 시간마다 **"약(about)"** 한 번의 잡을 생성한다.
  - 특정 환경(예: 컨트롤러 재시작)에서는 두 개의 잡이 만들어지거나, 아예 생성되지 않을 수도 있다.
  - 따라서 `잡`은 `멱등원, 즉 여러 번 실행되어도 괜찮도록 설계되어야 한다.`
- **100회 이상 일정 누락**
  - 컨트롤러가 마지막 일정부터 지금까지 **100회 이상의 일정이 누락**된 것을 감지하면
    - 잡을 실행하지 않고 "Too many missed start time (> 100)" 에러를 남긴다.
- **시작 마감 시간**
  - `startingDeadlineSeconds` 필드를 설정하면(예: 200초), 컨트롤러는 "총 누락 횟수" 대신 "최근 200초 내에 누락된 잡이 있는지"를 카운트한다.
  - 만약 200초 내에 누락된 잡이 1개 이상 감지되면 (100개가 넘었더라도) **하나의 잡을 즉시 실행**합니다.

---

4. **컨트롤러 버전**

- 쿠버네티스 v1.21부터 크론잡 컨트롤러의 V2 버전이 기본값이다.
- `CronJobControllerV2=false`라는 기능 게이트 플래그를 통해 V1로 되돌릴 수 있지만, 권장되지 않는다.
