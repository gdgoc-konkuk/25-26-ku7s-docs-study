애플리케이션의 스테이트풀을 관리하는데 사용하는 워크로드 API 오브젝트이다. 여러 개의 파드를 관리하고, 각 파드에 대한 고유한 정체성과 데이터를 유지한다.

- 파드 순서 보장: 파드를 순차적으로 생성, 삭제, 업데이트한다.
- 고유한 식별자 보존: 고유한 이름을 사용한다.
- 지속적인 스토리지: 각 파드에 연결된 Persistent Volume(PV)이 고유하고, 파드가 교체되어도 유지된다.
- 디플로이먼트와의 차이: Deployment는 파드가 모두 동일하고 교체 가능하지만, StatefulSet은 파드 간 개별성을 유지한다.

## 스테이트풀셋 사용

아래와 같은 상황일 때 StatefulSet 사용이 유용하다.

- **고정된 네트워크 이름(Stable Network ID)**
  바뀌지 않는 파드의 이름과 DNS 주소를 사용하기 때문에 안정적이다.
- **지속되는 스토리지(Stable Storage)**
  파드가 죽고 다시 만들어져도, 같은 PV가 같은 파드 이름에 연결되어 데이터가 유지된다.
- **순차적인 배포 / 스케일링(Ordered Deployment & Scaling)**
  파드를 순서대로 배포하고 삭제하기 때문에 파드간 의존성을 보장한다.
- **순차적 롤링 업데이트(Ordered Rolling Update)**
  한 노드씩 업데이트를 진행하기 때문에 전체 파드가 다운되는 것을 방지한다.

> 안전성이 필요하지 않은 경우 Deployment나 ReplicaSet이 더 효율적이다.

## 제한사항

- 스토리지 사전 준비가 필요하다.
- 데이터 보호를 위해 StatefulSet을 삭제하거나 축소해도 PV는 남기때문에 수동으로 정리해야 한다.
- 각 파드가 고유한 이름으로 통신하기 위해 헤드리스 서비스가 필요하다.
- 삭제 시 순차적 종료를 보장하지 않는다.
- 롤링 업데이트 시 오류가 발생하면 다음 단계로의 진행이 멈춰 수동 복구가 필요할 수 있다.

## 구성 요소

### 헤드리스 서비스

StatefulSet 파드들의 네트워크 도메인을 관리한다.

- `clusterIP: None`을 통해 헤드리스 서비스로 설정한다.
- 공개된 네트워크 주소 체계를 제공해 파드 간 통신을 제공한다.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  clusterIP: None
  selector:
    app: nginx
```

### StatefulSet

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  selector:
    matchLabels:
      app: nginx
  serviceName: "nginx"
  replicas: 3
  minReadySeconds: 10
```

- serviceName: 헤드리스 서비스 이름
- replicas: 파드의 개수
- minReadySeconds: 정상 가동까지의 생성 시간
- selector.matchLabels: 관리할 파드를 식별하는 라벨

### Pod Templat

파드가 포함할 컨테이너를 정의한다.

```yaml
template:
  metadata:
    labels:
      app: nginx
  spec:
    containers:
      - name: nginx
        image: registry.k8s.io/nginx-slim:0.8
        volumeMounts:
          - name: www
            mountPath: /usr/share/nginx/html
```

### **VolumeClaimTemplates (스토리지 설정)**

각 파드에 고유한 Persistent Volume Claim을 자동 생성한다.

```yaml
volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "my-storage-class"
      resources:
        requests:
          storage: 1Gi
```

## 파드 신원

스테이트풀셋 파드는 순서, 네트워크 신원, 스토리지로 구성되는 고유한 신원을 가진다.

- **순서 색인**: 자동으로 붙여지는 순서
  - 0부터 시작
  - 고유한 ID 역할로 재생성 시에도 같은 번호를 유지
- **시작 순서**: `.spec.oridnals.start`로 시작 번호 변경 가능
- **안정적인 네트워크 신원**: 각 파드는 StatefulSet 이름 + 순번으로 이루어진 고정 호스트명을 가진다.
  - DNS 관련
    DNS는 캐시를 사용해 한번 이 주소는 없다는 결과를 받으면 이 결과가 지속된다.
    → 파드 생성 전에 파드를 검색할 경우 실제로 파드가 생긴 후에도 잠깐 동안 못 찾는 오류가 발생할 수 있다.
- **안정된 스토리지**: 각 파드마다 전용 PersistentVolumeClaim(PVC)가 생성된다.
- **파드 이름 레이블**: 자동으로 `statefulset.kubernetes.io/pod-name: <pod-name>`을 자동으로 붙여 특정 파드를 참조하거나 서비스나 설정을 연결한다.

## 디플로이먼트와 스케일링 보증

- N개의 레플리카가 있는 스테이트풀셋이 파드를 배포할 때 연속해서 {0..N-1}의 순서로 생성한다.
- 파드가 삭제될 때는 {N-1..0}의 순서인 역순으로 종료된다.
- 파드에 스케일링 작업을 적용하기 전에 모든 선행 파드가 Running 및 Ready 상태여야 한다.
- 파드가 종료되기 전에 모든 후속 파드가 완전히 종료 되어야 한다.
- 안전 종료: .spec.terminationGracePeriodSeconds 값을 0으로 설정하면 비정상 종료 위험이 발생한다.
- `.spec.podManagementPolicy`를 통해 병렬로 파드를 관리할 수 있다.
  - OrderedReady: 순서대로 관리
  - Parallel: 동시에 생성하거나 삭제 → 순서가 존재하지 않음

## 업데이트 전략

`.spec.updateStrategy` 필드를 통해 자동화된 롤링 업데이트를 구성하고 업데이트 할 수 있다.

- OnDelete(삭제시): 스테이트풀셋 컨트롤러가 스테이트풀셋의 파드를 자동으로 업데이트하지 않고, 사용자는 컨트롤러가 `.spec.template`을 반영하도록 수동으로 파드를 삭제해야 한다.
- RollingUpdate(롤링 업데이트): 스테이트풀셋의 파드에 대한 롤링업데이트를 구현한다.

## 롤링 업데이트

`.spec.updateStrategy.type = RollingUpdate` 이면 StatefulSet은 파드를 순서대로 업데이트한다.

## Partition Rolling Update

`.spec.updateStrategy.rollingUpdate.partition` 값을 지정하면 특정 인덱스 이상의 파드만 업데이트된다.

- 카나리 배포: 일부 파드만 새 버전으로 테스트
- 단계적 롤아웃: 안전성 검증 후 점진적 확장

### 최대 비가용 파드 수

`.spec.updateStrategy.rollingUpdate.maxUnavailable`를 통해 롤링 업데이트 중 동시에 비활성화될 수 있는 파드 수를 설정한다.

### 강제 롤백

파드가 정상적으로 Ready 되지 않으면 StatefulSet은 롤아웃을 멈추고 대기 상태에 들어가는데 이 때, 템플릿을 올바른 구성으로 수정해 잘못된 파드들을 직접 삭제해야 한다.

## 퍼시스턴트볼륨클레임 유보

`.spec.persistentVolumeClaimRententionPolicy`는 스테이트풀셋의 생애주기 동안 PVC를 삭제할지, 어떨세 삭제할지를 선택적으로 정의하는 필드이다.

- API 서버와 컨트롤러 매니저의 StatefulSetAutoDeletePVC 기능 게이트 활성화가 필요하다.
- **정책**
  - whenDeleted: 삭제될 때 적용될 볼륨 유보 동작 설정
  - whenScaled: 스케일 다운시에 볼륨 유보 동작을 설정
- **값**
  - Delete: volumeClaimTemplate으로 생성된 모든 PVC는 파드가 삭제된 뒤에 삭제된다.
  - Retain: PCV는 항상 유지된다.
- StatefulSet 컨트롤러는 각 PVC에 소유자 참조를 추가해 가비지 컬렉터가 PVC를 정리할 수 있도록 한다.
- 컨트롤러가 일시 중단되면 PVC 소유자 참조가 즉시 갱신되지 않을 수 있다. → 직접 owner reference를 확인해야 한다.

### 레플리카

`.spec.replicas`를 통해 필요한 파드의 수를 지정한다.

- `kubectl scale` 명령으로 수동 조정도 가능하지만, `kubectl apply -f`로 매니페스트를 다시 적용하면 덮어씌워진다.
- HPA 사용시 `.spec.replicas`를 수동으로 설정하면 충돌 위험이 있다.
