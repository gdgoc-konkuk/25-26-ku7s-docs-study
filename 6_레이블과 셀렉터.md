# 🧩 Kubernetes Labels & Selectors

> **쿠버네티스(Kubernetes)** 에서 **레이블(Label)** 과 **셀렉터(Selector)** 는  
> 오브젝트(예: Pod, Service, ReplicaSet)를 효율적으로 **그룹화·선택·관리하기 위한 핵심 메커니즘**이다.

---

## 📘 1. 레이블 (Label)

**레이블(Label)** 은 파드(Pod)나 서비스(Service) 같은 **쿠버네티스 오브젝트에 부착되는 키-값(key-value) 쌍**이다.

```yaml
metadata:
    labels:
        app: nginx
        environment: production
```

### ✅ 특징

| 항목   | 설명                                              |
| ------ | ------------------------------------------------- |
| 정의   | 키-값 쌍으로 구성된 메타데이터                    |
| 목적   | 오브젝트를 그룹화하거나 검색하기 위해 사용        |
| 고유성 | 한 오브젝트 내에서 레이블 키는 고유해야 함        |
| 시점   | 생성 시 부여하거나, 이후 언제든 추가·수정 가능    |
| 용도   | CLI/UI에서 검색, 모니터링, 오토스케일링 등에 사용 |

💡 **레이블은 “시스템이 아닌 사용자 관점의 분류 태그”**
즉, 시스템 동작에 직접적인 영향은 없지만 관리 효율성을 극대화함.

---

## 💡 2. 사용 동기 (Motivation)

레이블은 쿠버네티스의 “조직 구조와 오브젝트를 느슨하게 연결”하는 수단이다.
→ **클러스터의 물리적 구조와 논리적 그룹화를 분리**할 수 있게 한다.

예시:

```yaml
release: stable / canary
environment: dev / qa / production
tier: frontend / backend / cache
partition: customerA / customerB
track: daily / weekly
```

이런 방식으로 **다차원적 엔티티(다중 릴리즈, 다중 계층, 다중 고객 그룹)** 를 손쉽게 관리할 수 있다.

---

## 🧩 3. 구문(Syntax) & 캐릭터 셋(Character Set)

레이블은 다음 형식을 따른다:

```
<optional-prefix>/<name> = <value>
```

### 🔹 키(Key)

-   선택적 접두사(prefix)와 이름(name)으로 구성
-   `/` 로 구분됨 (예: `app.kubernetes.io/name`)
-   접두사는 **DNS 하위 도메인 규칙을 따라야 함**

    -   253자 이하, 소문자, 숫자, `.` 가능

-   접두사 생략 시 → 개인용 레이블로 간주
-   `kubernetes.io/`와 `k8s.io/` 접두사는 **시스템 예약**

### 🔹 값(Value)

-   63자 이하
-   (공백 가능)
-   시작과 끝은 영숫자(`[A-Za-z0-9]`)
-   중간에는 `-`, `_`, `.` 사용 가능

---

## 🎯 4. 레이블 셀렉터 (Label Selector)

**레이블 셀렉터(Label Selector)** 는 특정 레이블 조건에 맞는 오브젝트를 선택하는 도구다.
이름(Name)이나 UID와 달리 **레이블은 고유하지 않으므로**, 다수의 리소스를 한 번에 선택할 수 있다.

쿠버네티스는 두 종류의 셀렉터를 지원한다.

| 종류                             | 설명                                            | 예시                               |
| -------------------------------- | ----------------------------------------------- | ---------------------------------- |
| **일치성 기준 (Equality-based)** | `=`, `==`, `!=` 연산자로 단순 비교              | `env=prod`, `tier!=frontend`       |
| **집합성 기준 (Set-based)**      | `in`, `notin`, `exists`, `!` 연산자로 집합 비교 | `env in (prod, qa)` , `!partition` |

---

### ⚙️ Equality-based Selector

```bash
kubectl get pods -l environment=production,tier!=frontend
```

-   `environment=production`
    → prod 환경의 모든 파드 선택
-   `tier!=frontend`
    → frontend가 아닌 모든 파드 포함
-   쉼표(,)는 `AND` 조건을 의미

---

### ⚙️ Set-based Selector

```bash
kubectl get pods -l 'environment in (production, qa),tier notin (frontend, backend)'
```

| 연산자   | 의미                 | 예시                          |
| -------- | -------------------- | ----------------------------- |
| `in`     | 집합 내에 포함       | `tier in (frontend, backend)` |
| `notin`  | 집합에 포함되지 않음 | `env notin (dev)`             |
| `exists` | 키가 존재함          | `partition`                   |
| `!`      | 키가 존재하지 않음   | `!partition`                  |

➡️ **AND 조건만 지원**, OR(`||`)는 불가.

---

## 🧠 5. API 연동 예시 (LIST & WATCH)

레이블 셀렉터는 **API 쿼리 파라미터**로도 사용 가능하다.

| 유형      | 쿼리 예시                                                 | 설명      |
| --------- | --------------------------------------------------------- | --------- |
| Equality  | `?labelSelector=environment%3Dproduction,tier%3Dfrontend` | 단순 비교 |
| Set-based | `?labelSelector=environment+in+%28production%2Cqa%29`     | 집합 조건 |

CLI 예시:

```bash
kubectl get pods -l environment=production,tier=frontend
kubectl get pods -l 'environment in (production, qa)'
```

---

## 🔁 6. 다른 리소스에서의 사용 (Reference in Objects)

`Service`, `ReplicationController`, `ReplicaSet` 등은
자신이 관리해야 할 **파드 집합을 레이블 셀렉터로 정의**한다.

### 예시 — Service

```yaml
apiVersion: v1
kind: Service
metadata:
    name: redis-service
spec:
    selector:
        component: redis
```

### 예시 — ReplicaSet

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
    name: redis-rs
spec:
    selector:
        matchLabels:
            component: redis
        matchExpressions:
            - { key: tier, operator: In, values: [cache] }
            - { key: environment, operator: NotIn, values: [dev] }
```

> ✅ `matchLabels` 와 `matchExpressions` 는 **AND 관계**로 평가됨.
> 즉, 모든 조건을 만족해야 파드가 선택된다.

---

## 🧩 7. 세트 기반 요건을 지원하는 리소스

| 리소스         | 지원 여부 | 설명                            |
| -------------- | --------- | ------------------------------- |
| **Job**        | ✅        | 배치성 작업에 조건 지정 가능    |
| **Deployment** | ✅        | ReplicaSet의 상위 리소스        |
| **ReplicaSet** | ✅        | 다차원 조건 기반 관리 가능      |
| **DaemonSet**  | ✅        | 노드 전체 혹은 조건별 파드 배포 |

```yaml
selector:
    matchLabels:
        component: redis
    matchExpressions:
        - { key: tier, operator: In, values: [cache] }
        - { key: environment, operator: NotIn, values: [dev] }
```

---

## 🖥️ 8. 노드 셋 선택 (Node Selection)

레이블은 **파드를 어떤 노드(Node)에 배치할지 제한**하는 데에도 사용된다.

### ✅ 기본형 (`nodeSelector`)

```yaml
spec:
    nodeSelector:
        accelerator: nvidia-tesla-p100
```

> 특정 레이블(`accelerator=nvidia-tesla-p100`)이 붙은 노드에만 파드 배치.

### 🚀 고급형 (`nodeAffinity`)

```yaml
affinity:
    nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
                - matchExpressions:
                      - key: env
                        operator: In
                        values: [production, qa]
```

> `env=production` 또는 `env=qa` 노드에서만 실행.
